on: [push, pull_request]
name: "Continuous Integration \U0001F44C\U0001F440"
jobs:
  testSuite:
    name: Run Test Suite and Perl Critic
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    - name: Test Docker Build
      run: |
        docker build -t difegue/lanraragi -f ./tools/build/docker/Dockerfile .
    - name: LANraragi Test Suite
      uses: ./.github/action-run-tests
    - name: Perl Critic
      uses: Difegue/action-perlcritic@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
          args: ./lib/* ./script/* ./tools/install.pl

  integrationTestsDocker:
    name: Run Docker Integration Tests
    runs-on: ubuntu-latest
    needs: testSuite
    steps:
      - name: Checkout LANraragi repository
        uses: actions/checkout@v4
        with:
          path: lanraragi
      - name: Checkout aio-lanraragi integration tests
        uses: actions/checkout@v4
        with:
          repository: psilabs-dev/aio-lanraragi
          ref: 6aa94af1d20b4001aeff6bfd53cca51d49648f89
          path: aio-lanraragi
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install aio-lanraragi package
        run: |
          cd aio-lanraragi
          python -m pip install --upgrade pip
          pip install ".[dev]"
      - name: Install integration test dependencies
        run: |
          cd aio-lanraragi/integration_tests
          pip install .
      - name: Run integration tests against local LANraragi build
        run: |
          cd aio-lanraragi/integration_tests
          export CI=true
          pytest tests --log-cli-level=INFO \
            --build "$GITHUB_WORKSPACE/lanraragi" \
            --docker-api \
            --npseed 42
        env:
          DOCKER_HOST: unix:///var/run/docker.sock
